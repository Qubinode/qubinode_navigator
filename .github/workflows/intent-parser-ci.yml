name: Intent Parser CI

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'intent_parser/**'
      - 'tests/unit/test_intent_*.py'
      - 'tests/unit/test_entity_extractor.py'
      - 'requirements-intent-parser.txt'
      - '.github/workflows/intent-parser-ci.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'intent_parser/**'
      - 'tests/unit/test_intent_*.py'
      - 'tests/unit/test_entity_extractor.py'
      - 'requirements-intent-parser.txt'
  workflow_dispatch:

permissions:
  contents: read

env:
  PYTHON_VERSION: '3.12'

jobs:
  test-intent-parser:
    name: Test Intent Parser
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Set up uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Install dependencies
        run: |
          uv pip install --system -r requirements-intent-parser.txt
          uv pip install --system pytest pytest-asyncio

      - name: Run intent parser tests
        run: |
          python -m pytest tests/unit/test_intent_classifier.py tests/unit/test_entity_extractor.py tests/unit/test_intent_router.py -v --tb=short 2>&1 | tee test_output.txt
          TEST_EXIT_CODE=${PIPESTATUS[0]}
          exit $TEST_EXIT_CODE

      - name: Validate import
        run: |
          python -c "from intent_parser import IntentParser; print('IntentParser import OK')"

      - name: Generate test summary
        if: always()
        run: |
          echo "## Intent Parser Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f test_output.txt ]; then
            PASSED=$(grep -oP '\d+ passed' test_output.txt || echo "0 passed")
            FAILED=$(grep -oP '\d+ failed' test_output.txt || echo "0 failed")
            ERRORS=$(grep -oP '\d+ error' test_output.txt || echo "0 errors")

            echo "- Passed: $PASSED" >> $GITHUB_STEP_SUMMARY
            echo "- Failed: $FAILED" >> $GITHUB_STEP_SUMMARY
            echo "- Errors: $ERRORS" >> $GITHUB_STEP_SUMMARY
          else
            echo "- No test output captured" >> $GITHUB_STEP_SUMMARY
          fi

  validate-mcp-server:
    name: Validate Intent Parser MCP Server
    runs-on: ubuntu-latest
    needs: test-intent-parser

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Set up uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Install dependencies
        run: |
          uv pip install --system -r requirements-intent-parser.txt

      - name: Validate MCP server syntax
        run: |
          python -m py_compile intent_parser/mcp_server.py
          echo "MCP server syntax valid"

      - name: Verify FastMCP decorators
        run: |
          if grep -q "@mcp.tool()" intent_parser/mcp_server.py; then
            echo "FastMCP decorators found"
          else
            echo "No FastMCP @mcp.tool() decorators found"
            exit 1
          fi

      - name: Verify tool docstrings
        run: |
          if grep -A 3 "@mcp.tool()" intent_parser/mcp_server.py | grep -q '"""'; then
            echo "MCP tools have documentation"
          else
            echo "MCP tools missing docstrings"
            exit 1
          fi

      - name: Test MCP server import
        run: |
          python -c "from intent_parser.mcp_server import mcp; print('MCP instance import OK')"
